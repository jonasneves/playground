<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Content Manager</title>
  <script src="https://oauth.neevs.io/github-auth.js?v=2" integrity="sha384-yCvoyjf6LKk2Yc6oSRenxRV0yFNdjeQ5ANuXIcRN50VoX/X8S4YJ9mU2+cT9MGW1" crossorigin="anonymous"></script>
  <script id="bootstrap"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #f5f7fa; display: flex; flex-direction: column; height: 100vh; }
    .header { background: #667eea; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
    .main { display: flex; flex: 1; overflow: hidden; }
    .sidebar { width: 250px; background: white; border-right: 1px solid #e2e8f0; overflow-y: auto; }
    .editor-area { flex: 1; display: flex; gap: 20px; padding: 20px; overflow: hidden; }
    .editor, .preview { flex: 1; display: flex; flex-direction: column; }
    .editor textarea { flex: 1; padding: 16px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: 'Monaco', monospace; font-size: 14px; resize: none; }
    .preview-content { flex: 1; background: white; padding: 20px; border-radius: 8px; overflow-y: auto; }
    .file-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f7fafc; }
    .file-item:hover { background: #f7fafc; }
    .file-item.active { background: #e6f2ff; border-left: 3px solid #667eea; }
    .btn { padding: 8px 16px; background: white; color: #667eea; border: 1px solid white; border-radius: 6px; cursor: pointer; margin-left: 8px; }
    .btn:hover { background: rgba(255,255,255,0.2); }
    .btn-success { background: #4caf50; color: white; border-color: #4caf50; }
    .btn-success:hover { background: #45a049; }
    h4 { margin: 0; padding: 16px; background: #f7fafc; border-bottom: 1px solid #e2e8f0; }
  </style>
</head>
<body>
  <div class="header">
    <h2>✏️ Content Manager</h2>
    <div>
      <button id="save-btn" class="btn btn-success" onclick="saveFile()" disabled>Save</button>
      <button class="btn" onclick="location.reload()">← Back</button>
    </div>
  </div>

  <div class="main">
    <div class="sidebar">
      <h4>Content Files</h4>
      <div id="file-list"></div>
    </div>

    <div class="editor-area">
      <div class="editor">
        <h3>Editor</h3>
        <textarea id="editor" placeholder="Select a file to edit..." oninput="updatePreview()"></textarea>
      </div>

      <div class="preview">
        <h3>Preview</h3>
        <div id="preview" class="preview-content"></div>
      </div>
    </div>
  </div>

  <script>
    let repo, currentFile = null;

    GitHubAuth.init({
      autoRedirect: true,
      onLogin: async (user) => {
        const response = await fetch(
          'https://api.github.com/repos/jonasneves/duke-capstone/contents/shared/utils/github-api.js',
          { headers: { 'Authorization': `Bearer ${GitHubAuth.getToken()}` }}
        );
        const data = await response.json();
        eval(decodeURIComponent(escape(atob(data.content))));
        repo = initRepo(GitHubAuth.getToken());
        await loadFiles();
      }
    });

    async function loadFiles() {
      const files = await repo.listDirectory('content');
      const mdFiles = files.filter(f => f.name.endsWith('.md'));

      const fileList = document.getElementById('file-list');
      mdFiles.forEach(file => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.textContent = file.name;
        item.onclick = () => openFile(file);
        fileList.appendChild(item);
      });
    }

    async function openFile(file) {
      const data = await repo.getFile(file.path);
      currentFile = { ...data, path: file.path };

      document.getElementById('editor').value = data.content;
      updatePreview();
      document.getElementById('save-btn').disabled = false;

      document.querySelectorAll('.file-item').forEach(item => {
        item.classList.toggle('active', item.textContent === file.name);
      });
    }

    function updatePreview() {
      const markdown = document.getElementById('editor').value;
      document.getElementById('preview').innerHTML = marked.parse(markdown);
    }

    async function saveFile() {
      if (!currentFile) return;

      const content = document.getElementById('editor').value;
      const message = `Update ${currentFile.path.split('/').pop()}`;

      try {
        await repo.updateFile(currentFile.path, content, currentFile.sha, message);
        alert('Saved successfully!');

        // Refresh file data
        const data = await repo.getFile(currentFile.path);
        currentFile.sha = data.sha;
      } catch (error) {
        alert(`Error: ${error.message}`);
      }
    }
  </script>
</body>
</html>
