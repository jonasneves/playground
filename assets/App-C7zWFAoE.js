import{j as e,b as G,u as W,c as D,a as U,A}from"./main-DEWPCtcH.js";import{r}from"./state-DOKsaQ-a.js";import{R as F,T as J,L as V,C as _,A as B,b as k}from"./ui-BzbG-TcE.js";import{u as M}from"./index-Ctw9DyCw.js";import"./vendor-CZvkgD4c.js";function q({children:n,oauthServiceUrl:t,onAuthChange:l,isAuthenticated:d}){const[s,o]=r.useState(!0),[c,m]=r.useState(!1);return r.useEffect(()=>{const i=document.createElement("script");return i.src=`${t}/github-auth.js?v=2`,i.integrity="sha384-yCvoyjf6LKk2Yc6oSRenxRV0yFNdjeQ5ANuXIcRN50VoX/X8S4YJ9mU2+cT9MGW1",i.crossOrigin="anonymous",i.async=!0,i.onload=()=>{m(!0)},i.onerror=()=>{console.error("Failed to load OAuth script"),o(!1)},document.head.appendChild(i),()=>{document.head.removeChild(i)}},[t]),r.useEffect(()=>{if(c)if(window.GitHubAuth.isAuthenticated()){const i=window.GitHubAuth.getUser(),u=window.GitHubAuth.getToken();i&&u&&(l(u,i),o(!1))}else window.GitHubAuth.init({scope:"repo",onLogin:i=>{const u=window.GitHubAuth.getUser();u&&(l(i,u),o(!1))}}),o(!1)},[c,l]),s?e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Initializing..."})]})}):d?e.jsx(e.Fragment,{children:n}):e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("h2",{children:"Authentication Required"}),e.jsx("p",{style:{marginTop:16,marginBottom:24,opacity:.9},children:"Please sign in with GitHub to access the gallery"}),e.jsx("button",{onClick:()=>window.GitHubAuth.login(),style:{background:"linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)",color:"white",border:"none",padding:"12px 24px",borderRadius:"8px",fontSize:"16px",fontWeight:"500",cursor:"pointer"},children:"Sign in with GitHub"})]})})}function N({user:n,onLogout:t,onClearCache:l}){const[d,s]=r.useState(!1),o=r.useRef(null);r.useEffect(()=>{function m(i){o.current&&!o.current.contains(i.target)&&s(!1)}return document.addEventListener("click",m),()=>document.removeEventListener("click",m)},[]);const c=()=>{confirm("Clear all cached data? Apps will reload from the repository.")&&(l(),window.location.reload())};return n?e.jsxs("div",{ref:o,style:{position:"relative"},children:[e.jsxs("div",{className:"user-pill",onClick:()=>s(!d),children:[e.jsx("img",{src:n.avatar_url,alt:n.login,className:"user-avatar"}),e.jsx("span",{style:{fontWeight:500,fontSize:"14px"},children:n.name||n.login})]}),e.jsxs("div",{className:`user-menu ${d?"show":""}`,children:[e.jsxs("button",{onClick:()=>window.location.reload(),children:[e.jsx(F,{size:16})," Refresh"]}),e.jsxs("button",{onClick:c,children:[e.jsx(J,{size:16})," Clear Cache"]}),e.jsxs("button",{onClick:t,children:[e.jsx(V,{size:16})," Logout"]})]})]}):null}function K(n,t){if(!n?.minLauncherVersion||!t)return null;const l=t.split(".").map(Number),d=n.minLauncherVersion.split(".").map(Number);for(let s=0;s<3;s++){if(l[s]<d[s])return`Requires launcher v${n.minLauncherVersion}`;if(l[s]>d[s])return null}return null}function P({appName:n,manifest:t,path:l,onLaunch:d,version:s}){if(!t)return e.jsx("div",{className:"app-card",children:e.jsxs("div",{className:"app-card-body",children:[e.jsx("h3",{children:n}),e.jsx("p",{style:{color:"#ccc"},children:"Loading..."})]})});const o=K(t,s);return e.jsxs("div",{className:"app-card",children:[t.thumbnail&&e.jsx("img",{src:t.thumbnail,alt:t.name,onError:c=>{c.currentTarget.style.display="none"}}),e.jsxs("div",{className:"app-card-body",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{children:t.description}),o&&e.jsxs("div",{style:{color:"#f59e0b",fontSize:"13px",marginBottom:"12px",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx(_,{size:16})," ",o]}),t.tech&&t.tech.length>0&&e.jsx("div",{className:"app-meta",children:t.tech.map(c=>e.jsx("span",{className:"badge",children:c},c))}),e.jsxs("button",{onClick:()=>d(l,t.name),className:"launch-btn",children:["Launch App ",e.jsx(B,{size:16})]})]})]})}function X({config:n,user:t,token:l,useGitHubAPI:d,onLogout:s,onClearCache:o,onTrack:c,onNavigate:m}){const[i,u]=r.useState([]),[z,C]=r.useState(!0),[L,T]=r.useState(null),[y,S]=r.useState(null),[$,b]=r.useState(!1),[H,E]=r.useState(!1),w=d(n.repository.owner,n.repository.name),x=r.useRef(null);r.useEffect(()=>{I()},[]),r.useEffect(()=>{function a(h){h.key==="Escape"&&y&&R()}return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[y]),r.useEffect(()=>{function a(h){h.data==="close-app"&&R()}return window.addEventListener("message",a),()=>window.removeEventListener("message",a)},[]);const I=async()=>{try{C(!0);const h=(await w.listDirectory("apps")).filter(p=>p.type==="dir"),g=h.map(p=>({name:p.name,path:p.path,manifest:null}));u(g);for(let p=0;p<h.length;p++){await new Promise(f=>setTimeout(f,p*100));const v=await w.getManifest(h[p].path);v&&u(f=>f.map(j=>j.name===h[p].name?{...j,manifest:v}:j))}C(!1)}catch(a){T(a.message),C(!1)}},O=r.useCallback(async(a,h)=>{try{b(!0),c?.("app_launch",{appName:h,appPath:a});const g=i.find(j=>j.path===a)?.manifest;if(g?.reactRoute&&m){m(g.reactRoute),b(!1);return}S({path:a,name:h});const p=await w.getFile(`${a}/index.html`),v=`<script>
        window.INJECTED_TOKEN = ${JSON.stringify(l)};
        window.INJECTED_USER = ${JSON.stringify(t)};
        window.PARENT_REPO = window.parent.repo;
      <\/script>`,f=p.content.replace("<head>","<head>"+v);x.current&&(x.current.srcdoc=f,x.current.onload=()=>{b(!1),E(!0),setTimeout(()=>E(!1),3e3)})}catch(g){alert(`Error loading app: ${g.message}`),b(!1),S(null)}},[w,l,t,c,i,m]),R=r.useCallback(()=>{S(null),E(!1),x.current&&(x.current.srcdoc="")},[]);return z&&i.length===0?e.jsxs("div",{children:[e.jsx(N,{user:t,onLogout:s,onClearCache:o}),e.jsxs("div",{style:{background:`linear-gradient(135deg, ${n.branding.theme.primary} 0%, ${n.branding.theme.secondary} 100%)`,color:"white",padding:"48px 20px",textAlign:"center",marginBottom:"48px"},children:[e.jsxs("h1",{style:{margin:"0 0 8px 0",fontSize:"2.5em",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:"12px"},children:[e.jsx(k,{size:32})," ",n.branding.title]}),e.jsx("p",{style:{margin:0,opacity:.95,fontSize:"1.05em"},children:n.branding.subtitle})]}),e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Loading applications..."})]})})]}):L?e.jsxs("div",{children:[e.jsx(N,{user:t,onLogout:s,onClearCache:o}),e.jsxs("div",{className:"error",children:[e.jsx("strong",{children:"Error:"})," ",L]})]}):e.jsxs("div",{children:[e.jsx(N,{user:t,onLogout:s,onClearCache:o}),e.jsxs("div",{style:{background:`linear-gradient(135deg, ${n.branding.theme.primary} 0%, ${n.branding.theme.secondary} 100%)`,color:"white",padding:"48px 20px",textAlign:"center",marginBottom:"48px"},children:[e.jsxs("h1",{style:{margin:"0 0 8px 0",fontSize:"2.5em",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:"12px"},children:[e.jsx(k,{size:32})," ",n.branding.title]}),e.jsx("p",{style:{margin:0,opacity:.95,fontSize:"1.05em"},children:n.branding.subtitle})]}),e.jsx("div",{className:"app-grid",children:i.map(a=>e.jsx(P,{appName:a.name,manifest:a.manifest,path:a.path,onLaunch:O},a.name))}),y&&e.jsxs(e.Fragment,{children:[e.jsx("iframe",{ref:x,className:"app-frame",style:{display:"block"},title:y.name}),$&&e.jsx("div",{className:"app-loader",style:{display:"flex"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Loading app..."})]})}),e.jsx("div",{className:`hint ${H?"visible":""}`,children:"Press ESC to return to gallery"})]})]})}function ne(){const n=G(),{user:t,token:l,isAuthenticated:d,setAuth:s,logout:o}=W(),{clearCache:c}=D(),{track:m}=U();return e.jsx(q,{oauthServiceUrl:A.oauth.serviceUrl,onAuthChange:(i,u)=>{i&&u&&s(i,u)},isAuthenticated:d,children:e.jsx(X,{config:A,user:t,token:l,useGitHubAPI:M,onLogout:o,onClearCache:()=>c(A.repository.owner,A.repository.name),onTrack:m,onNavigate:i=>n(i)})})}export{ne as default};
