import{j as e,b as O,u as D,c as W,a as U,A}from"./main-C7Gb6osA.js";import{r}from"./state-DOKsaQ-a.js";import{R as _,T as B,L as F,C as J,A as q,b as R}from"./ui-BzbG-TcE.js";import{u as M}from"./index-DWvYK_eL.js";import"./vendor-CZvkgD4c.js";function P({children:n,oauthServiceUrl:t,onAuthChange:l,isAuthenticated:d}){const[s,a]=r.useState(!0),[c,m]=r.useState(!1);return r.useEffect(()=>{const i=document.createElement("script");return i.src=`${t}/github-auth.js?v=${Date.now()}`,i.async=!0,i.onload=()=>{setTimeout(()=>{window.GitHubAuth?m(!0):(console.error("GitHubAuth not available after script load"),a(!1))},100)},i.onerror=()=>{console.error("Failed to load OAuth script"),a(!1)},document.head.appendChild(i),()=>{document.head.contains(i)&&document.head.removeChild(i)}},[t]),r.useEffect(()=>{if(c)if(window.GitHubAuth.isAuthenticated()){const i=window.GitHubAuth.getUser(),p=window.GitHubAuth.getToken();i&&p&&(l(p,i),a(!1))}else window.GitHubAuth.init({scope:"repo",onLogin:i=>{const p=window.GitHubAuth.getUser();p&&(l(i,p),a(!1))}}),a(!1)},[c,l]),s?e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Initializing..."})]})}):d?e.jsx(e.Fragment,{children:n}):e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("h2",{children:"Authentication Required"}),e.jsx("p",{style:{marginTop:16,marginBottom:24,opacity:.9},children:"Please sign in with GitHub to access the gallery"}),e.jsx("button",{onClick:()=>window.GitHubAuth.login(),style:{background:"linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)",color:"white",border:"none",padding:"12px 24px",borderRadius:"8px",fontSize:"16px",fontWeight:"500",cursor:"pointer"},children:"Sign in with GitHub"})]})})}function N({user:n,onLogout:t,onClearCache:l}){const[d,s]=r.useState(!1),a=r.useRef(null);r.useEffect(()=>{function m(i){a.current&&!a.current.contains(i.target)&&s(!1)}return document.addEventListener("click",m),()=>document.removeEventListener("click",m)},[]);const c=()=>{confirm("Clear all cached data? Apps will reload from the repository.")&&(l(),window.location.reload())};return n?e.jsxs("div",{ref:a,style:{position:"relative"},children:[e.jsxs("div",{className:"user-pill",onClick:()=>s(!d),children:[e.jsx("img",{src:n.avatar_url,alt:n.login,className:"user-avatar"}),e.jsx("span",{style:{fontWeight:500,fontSize:"14px"},children:n.name||n.login})]}),e.jsxs("div",{className:`user-menu ${d?"show":""}`,children:[e.jsxs("button",{onClick:()=>window.location.reload(),children:[e.jsx(_,{size:16})," Refresh"]}),e.jsxs("button",{onClick:c,children:[e.jsx(B,{size:16})," Clear Cache"]}),e.jsxs("button",{onClick:t,children:[e.jsx(F,{size:16})," Logout"]})]})]}):null}function V(n,t){if(!n?.minLauncherVersion||!t)return null;const l=t.split(".").map(Number),d=n.minLauncherVersion.split(".").map(Number);for(let s=0;s<3;s++){if(l[s]<d[s])return`Requires launcher v${n.minLauncherVersion}`;if(l[s]>d[s])return null}return null}function K({appName:n,manifest:t,path:l,onLaunch:d,version:s}){if(!t)return e.jsx("div",{className:"app-card",children:e.jsxs("div",{className:"app-card-body",children:[e.jsx("h3",{children:n}),e.jsx("p",{style:{color:"#ccc"},children:"Loading..."})]})});const a=V(t,s);return e.jsxs("div",{className:"app-card",children:[t.thumbnail&&e.jsx("img",{src:t.thumbnail,alt:t.name,onError:c=>{c.currentTarget.style.display="none"}}),e.jsxs("div",{className:"app-card-body",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{children:t.description}),a&&e.jsxs("div",{style:{color:"#f59e0b",fontSize:"13px",marginBottom:"12px",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx(J,{size:16})," ",a]}),t.tech&&t.tech.length>0&&e.jsx("div",{className:"app-meta",children:t.tech.map(c=>e.jsx("span",{className:"badge",children:c},c))}),e.jsxs("button",{onClick:()=>d(l,t.name),className:"launch-btn",children:["Launch App ",e.jsx(q,{size:16})]})]})]})}function Q({config:n,user:t,token:l,useGitHubAPI:d,onLogout:s,onClearCache:a,onTrack:c,onNavigate:m}){const[i,p]=r.useState([]),[z,C]=r.useState(!0),[L,T]=r.useState(null),[b,E]=r.useState(null),[H,w]=r.useState(!1),[$,S]=r.useState(!1),y=d(n.repository.owner,n.repository.name),x=r.useRef(null);r.useEffect(()=>{G()},[]),r.useEffect(()=>{function o(h){h.key==="Escape"&&b&&k()}return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[b]),r.useEffect(()=>{function o(h){h.data==="close-app"&&k()}return window.addEventListener("message",o),()=>window.removeEventListener("message",o)},[]);const G=async()=>{try{C(!0);const h=(await y.listDirectory("apps")).filter(u=>u.type==="dir"),f=h.map(u=>({name:u.name,path:u.path,manifest:null}));p(f);for(let u=0;u<h.length;u++){await new Promise(g=>setTimeout(g,u*100));const v=await y.getManifest(h[u].path);v&&p(g=>g.map(j=>j.name===h[u].name?{...j,manifest:v}:j))}C(!1)}catch(o){T(o.message),C(!1)}},I=r.useCallback(async(o,h)=>{try{w(!0),c?.("app_launch",{appName:h,appPath:o});const f=i.find(j=>j.path===o)?.manifest;if(f?.reactRoute&&m){m(f.reactRoute),w(!1);return}E({path:o,name:h});const u=await y.getFile(`${o}/index.html`),v=`<script>
        window.INJECTED_TOKEN = ${JSON.stringify(l)};
        window.INJECTED_USER = ${JSON.stringify(t)};
        window.PARENT_REPO = window.parent.repo;
      <\/script>`,g=u.content.replace("<head>","<head>"+v);x.current&&(x.current.srcdoc=g,x.current.onload=()=>{w(!1),S(!0),setTimeout(()=>S(!1),3e3)})}catch(f){alert(`Error loading app: ${f.message}`),w(!1),E(null)}},[y,l,t,c,i,m]),k=r.useCallback(()=>{E(null),S(!1),x.current&&(x.current.srcdoc="")},[]);return z&&i.length===0?e.jsxs("div",{children:[e.jsx(N,{user:t,onLogout:s,onClearCache:a}),e.jsxs("div",{style:{background:`linear-gradient(135deg, ${n.branding.theme.primary} 0%, ${n.branding.theme.secondary} 100%)`,color:"white",padding:"48px 20px",textAlign:"center",marginBottom:"48px"},children:[e.jsxs("h1",{style:{margin:"0 0 8px 0",fontSize:"2.5em",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:"12px"},children:[e.jsx(R,{size:32})," ",n.branding.title]}),e.jsx("p",{style:{margin:0,opacity:.95,fontSize:"1.05em"},children:n.branding.subtitle})]}),e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Loading applications..."})]})})]}):L?e.jsxs("div",{children:[e.jsx(N,{user:t,onLogout:s,onClearCache:a}),e.jsxs("div",{className:"error",children:[e.jsx("strong",{children:"Error:"})," ",L]})]}):e.jsxs("div",{children:[e.jsx(N,{user:t,onLogout:s,onClearCache:a}),e.jsxs("div",{style:{background:`linear-gradient(135deg, ${n.branding.theme.primary} 0%, ${n.branding.theme.secondary} 100%)`,color:"white",padding:"48px 20px",textAlign:"center",marginBottom:"48px"},children:[e.jsxs("h1",{style:{margin:"0 0 8px 0",fontSize:"2.5em",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:"12px"},children:[e.jsx(R,{size:32})," ",n.branding.title]}),e.jsx("p",{style:{margin:0,opacity:.95,fontSize:"1.05em"},children:n.branding.subtitle})]}),e.jsx("div",{className:"app-grid",children:i.map(o=>e.jsx(K,{appName:o.name,manifest:o.manifest,path:o.path,onLaunch:I},o.name))}),b&&e.jsxs(e.Fragment,{children:[e.jsx("iframe",{ref:x,className:"app-frame",style:{display:"block"},title:b.name}),H&&e.jsx("div",{className:"app-loader",style:{display:"flex"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Loading app..."})]})}),e.jsx("div",{className:`hint ${$?"visible":""}`,children:"Press ESC to return to gallery"})]})]})}function ne(){const n=O(),{user:t,token:l,isAuthenticated:d,setAuth:s,logout:a}=D(),{clearCache:c}=W(),{track:m}=U();return e.jsx(P,{oauthServiceUrl:A.oauth.serviceUrl,onAuthChange:(i,p)=>{i&&p&&s(i,p)},isAuthenticated:d,children:e.jsx(Q,{config:A,user:t,token:l,useGitHubAPI:M,onLogout:a,onClearCache:()=>c(A.repository.owner,A.repository.name),onTrack:m,onNavigate:i=>n(i)})})}export{ne as default};
