import{j as e,b as W,u as _,c as D,a as J,A as N}from"./main-DpeyGvqJ.js";import{r as s}from"./state-DOKsaQ-a.js";import{R as U,T as H,L as F,C as M,A as P,b as I}from"./ui-BzbG-TcE.js";import{u as q}from"./index-CzpzFMnC.js";import"./vendor-CZvkgD4c.js";function G({children:n,oauthServiceUrl:t,storageKey:a="github-oauth",onAuthChange:c,isAuthenticated:i}){const[d,o]=s.useState(!0),[u,p]=s.useState(null);s.useEffect(()=>{j()},[]);async function j(){const g=new URLSearchParams(window.location.search),w=g.get("code"),k=g.get("state");if(w&&k){try{const l=await fetch(`${t}/callback?code=${w}&state=${k}`);if(!l.ok)throw new Error("Failed to authenticate");const m=await l.json();if(m.token){const y=await fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${m.token}`,Accept:"application/vnd.github.v3+json"}});if(y.ok){const f=await y.json();localStorage.setItem(a,JSON.stringify({token:m.token,user:f})),c(m.token,f),window.history.replaceState({},document.title,window.location.pathname+window.location.hash)}}}catch(l){console.error("OAuth callback error:",l),p(l.message)}o(!1);return}try{const l=localStorage.getItem(a);if(l){const{token:m,user:y}=JSON.parse(l);(await fetch("https://api.github.com/user",{headers:{Authorization:`Bearer ${m}`,Accept:"application/vnd.github.v3+json"}})).ok?c(m,y):localStorage.removeItem(a)}}catch(l){console.error("Error checking stored auth:",l)}o(!1)}function R(){const g=Math.random().toString(36).substring(7);sessionStorage.setItem("oauth_state",g);const w=encodeURIComponent(window.location.origin+window.location.pathname);window.location.href=`${t}/authorize?state=${g}&redirect_uri=${w}`}return d?e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Initializing..."})]})}):u?e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("h2",{style:{color:"#ef4444"},children:"Authentication Error"}),e.jsx("p",{style:{marginTop:16,marginBottom:24,opacity:.9},children:u}),e.jsx("button",{onClick:()=>{p(null),o(!1)},style:{background:"#6b7280",color:"white",border:"none",padding:"12px 24px",borderRadius:"8px",fontSize:"16px",fontWeight:"500",cursor:"pointer"},children:"Try Again"})]})}):i?e.jsx(e.Fragment,{children:n}):e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("h2",{children:"Authentication Required"}),e.jsx("p",{style:{marginTop:16,marginBottom:24,opacity:.9},children:"Please sign in with GitHub to access the gallery"}),e.jsx("button",{onClick:R,style:{background:"linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)",color:"white",border:"none",padding:"12px 24px",borderRadius:"8px",fontSize:"16px",fontWeight:"500",cursor:"pointer"},children:"Sign in with GitHub"})]})})}function z({user:n,onLogout:t,onClearCache:a}){const[c,i]=s.useState(!1),d=s.useRef(null);s.useEffect(()=>{function u(p){d.current&&!d.current.contains(p.target)&&i(!1)}return document.addEventListener("click",u),()=>document.removeEventListener("click",u)},[]);const o=()=>{confirm("Clear all cached data? Apps will reload from the repository.")&&(a(),window.location.reload())};return n?e.jsxs("div",{ref:d,style:{position:"relative"},children:[e.jsxs("div",{className:"user-pill",onClick:()=>i(!c),children:[e.jsx("img",{src:n.avatar_url,alt:n.login,className:"user-avatar"}),e.jsx("span",{style:{fontWeight:500,fontSize:"14px"},children:n.name||n.login})]}),e.jsxs("div",{className:`user-menu ${c?"show":""}`,children:[e.jsxs("button",{onClick:()=>window.location.reload(),children:[e.jsx(U,{size:16})," Refresh"]}),e.jsxs("button",{onClick:o,children:[e.jsx(H,{size:16})," Clear Cache"]}),e.jsxs("button",{onClick:t,children:[e.jsx(F,{size:16})," Logout"]})]})]}):null}function V(n,t){if(!n?.minLauncherVersion||!t)return null;const a=t.split(".").map(Number),c=n.minLauncherVersion.split(".").map(Number);for(let i=0;i<3;i++){if(a[i]<c[i])return`Requires launcher v${n.minLauncherVersion}`;if(a[i]>c[i])return null}return null}function K({appName:n,manifest:t,path:a,onLaunch:c,version:i}){if(!t)return e.jsx("div",{className:"app-card",children:e.jsxs("div",{className:"app-card-body",children:[e.jsx("h3",{children:n}),e.jsx("p",{style:{color:"#ccc"},children:"Loading..."})]})});const d=V(t,i);return e.jsxs("div",{className:"app-card",children:[t.thumbnail&&e.jsx("img",{src:t.thumbnail,alt:t.name,onError:o=>{o.currentTarget.style.display="none"}}),e.jsxs("div",{className:"app-card-body",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{children:t.description}),d&&e.jsxs("div",{style:{color:"#f59e0b",fontSize:"13px",marginBottom:"12px",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx(M,{size:16})," ",d]}),t.tech&&t.tech.length>0&&e.jsx("div",{className:"app-meta",children:t.tech.map(o=>e.jsx("span",{className:"badge",children:o},o))}),e.jsxs("button",{onClick:()=>c(a,t.name),className:"launch-btn",children:["Launch App ",e.jsx(P,{size:16})]})]})]})}function Q({config:n,user:t,token:a,useGitHubAPI:c,onLogout:i,onClearCache:d,onTrack:o,onNavigate:u}){const[p,j]=s.useState([]),[R,g]=s.useState(!0),[w,k]=s.useState(null),[l,m]=s.useState(null),[y,f]=s.useState(!1),[T,L]=s.useState(!1),C=c(n.repository.owner,n.repository.name),b=s.useRef(null);s.useEffect(()=>{O()},[]),s.useEffect(()=>{function r(x){x.key==="Escape"&&l&&$()}return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[l]),s.useEffect(()=>{function r(x){x.data==="close-app"&&$()}return window.addEventListener("message",r),()=>window.removeEventListener("message",r)},[]);const O=async()=>{try{g(!0);const x=(await C.listDirectory("apps")).filter(h=>h.type==="dir"),v=x.map(h=>({name:h.name,path:h.path,manifest:null}));j(v);for(let h=0;h<x.length;h++){await new Promise(A=>setTimeout(A,h*100));const E=await C.getManifest(x[h].path);E&&j(A=>A.map(S=>S.name===x[h].name?{...S,manifest:E}:S))}g(!1)}catch(r){k(r.message),g(!1)}},B=s.useCallback(async(r,x)=>{try{f(!0),o?.("app_launch",{appName:x,appPath:r});const v=p.find(S=>S.path===r)?.manifest;if(v?.reactRoute&&u){u(v.reactRoute),f(!1);return}m({path:r,name:x});const h=await C.getFile(`${r}/index.html`),E=`<script>
        window.INJECTED_TOKEN = ${JSON.stringify(a)};
        window.INJECTED_USER = ${JSON.stringify(t)};
        window.PARENT_REPO = window.parent.repo;
      <\/script>`,A=h.content.replace("<head>","<head>"+E);b.current&&(b.current.srcdoc=A,b.current.onload=()=>{f(!1),L(!0),setTimeout(()=>L(!1),3e3)})}catch(v){alert(`Error loading app: ${v.message}`),f(!1),m(null)}},[C,a,t,o,p,u]),$=s.useCallback(()=>{m(null),L(!1),b.current&&(b.current.srcdoc="")},[]);return R&&p.length===0?e.jsxs("div",{children:[e.jsx(z,{user:t,onLogout:i,onClearCache:d}),e.jsxs("div",{style:{background:`linear-gradient(135deg, ${n.branding.theme.primary} 0%, ${n.branding.theme.secondary} 100%)`,color:"white",padding:"48px 20px",textAlign:"center",marginBottom:"48px"},children:[e.jsxs("h1",{style:{margin:"0 0 8px 0",fontSize:"2.5em",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:"12px"},children:[e.jsx(I,{size:32})," ",n.branding.title]}),e.jsx("p",{style:{margin:0,opacity:.95,fontSize:"1.05em"},children:n.branding.subtitle})]}),e.jsx("div",{className:"loading",children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Loading applications..."})]})})]}):w?e.jsxs("div",{children:[e.jsx(z,{user:t,onLogout:i,onClearCache:d}),e.jsxs("div",{className:"error",children:[e.jsx("strong",{children:"Error:"})," ",w]})]}):e.jsxs("div",{children:[e.jsx(z,{user:t,onLogout:i,onClearCache:d}),e.jsxs("div",{style:{background:`linear-gradient(135deg, ${n.branding.theme.primary} 0%, ${n.branding.theme.secondary} 100%)`,color:"white",padding:"48px 20px",textAlign:"center",marginBottom:"48px"},children:[e.jsxs("h1",{style:{margin:"0 0 8px 0",fontSize:"2.5em",fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center",gap:"12px"},children:[e.jsx(I,{size:32})," ",n.branding.title]}),e.jsx("p",{style:{margin:0,opacity:.95,fontSize:"1.05em"},children:n.branding.subtitle})]}),e.jsx("div",{className:"app-grid",children:p.map(r=>e.jsx(K,{appName:r.name,manifest:r.manifest,path:r.path,onLaunch:B},r.name))}),l&&e.jsxs(e.Fragment,{children:[e.jsx("iframe",{ref:b,className:"app-frame",style:{display:"block"},title:l.name}),y&&e.jsx("div",{className:"app-loader",style:{display:"flex"},children:e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{border:"4px solid rgba(255,255,255,0.3)",borderRadius:"50%",borderTopColor:"white",width:"50px",height:"50px",animation:"spin 1s linear infinite",margin:"0 auto 20px"}}),e.jsx("p",{children:"Loading app..."})]})}),e.jsx("div",{className:`hint ${T?"visible":""}`,children:"Press ESC to return to gallery"})]})]})}function ne(){const n=W(),{user:t,token:a,isAuthenticated:c,setAuth:i,logout:d}=_(),{clearCache:o}=D(),{track:u}=J();return e.jsx(G,{oauthServiceUrl:N.oauth.serviceUrl,onAuthChange:(p,j)=>{p&&j&&i(p,j)},isAuthenticated:c,children:e.jsx(Q,{config:N,user:t,token:a,useGitHubAPI:q,onLogout:d,onClearCache:()=>o(N.repository.owner,N.repository.name),onTrack:u,onNavigate:p=>n(p)})})}export{ne as default};
