import{j as e,A as g}from"./main-C7Gb6osA.js";import{r as s}from"./state-DOKsaQ-a.js";import{F as D,a as E,S as F,X as L}from"./ui-BzbG-TcE.js";import{u as I}from"./index-DWvYK_eL.js";import{u as P}from"./usePerformanceMonitor-DVrqK2Ru.js";import"./vendor-CZvkgD4c.js";function $({files:t,onFileSelect:o,selectedFile:d,onLoadDirectory:h}){const[c,a]=s.useState({}),f=async r=>{const i=c[r.path]||{isOpen:!1,children:[],isLoaded:!1};if(i.isOpen){a(n=>({...n,[r.path]:{...i,isOpen:!1}}));return}if(i.isLoaded)a(n=>({...n,[r.path]:{...i,isOpen:!0}}));else{const n=await h(r.path);a(l=>({...l,[r.path]:{isOpen:!0,children:n,isLoaded:!0}}))}},v=(r,i=0)=>{const n=r.type==="dir",l=c[r.path],m=l?.isOpen||!1,y=d?.path===r.path;return n?e.jsxs("div",{children:[e.jsxs("div",{className:`dir-item ${m?"open":""}`,style:{paddingLeft:`${i*16+16}px`},onClick:()=>f(r),children:[e.jsx(D,{size:16}),r.name]}),m&&l.children.length>0&&e.jsx("div",{className:"dir-children",children:l.children.map(x=>v(x,i+1))})]},r.path):e.jsxs("div",{className:`file-item ${y?"active":""}`,style:{paddingLeft:`${i*16+16}px`},onClick:()=>o(r),children:[e.jsx(E,{size:16}),r.name]},r.path)};return e.jsx("div",{children:t.map(r=>v(r))})}function _({content:t,onChange:o,disabled:d,placeholder:h}){const c=s.useRef(null);return s.useEffect(()=>{t&&c.current&&c.current.focus()},[t]),e.jsxs("div",{className:"editor",children:[e.jsx("h3",{children:"Editor"}),e.jsx("textarea",{ref:c,id:"editor",value:t,onChange:a=>o(a.target.value),disabled:d,placeholder:h||"Select a file to edit..."})]})}function M(){const[t,o]=s.useState(""),[d,h]=s.useState(!1),[c,a]=s.useState(null),f=s.useRef(null),v=s.useRef(0),r=s.useRef(null);s.useEffect(()=>{const n=new Worker(new URL(""+new URL("markdown.worker-Dti5hhgv.js",import.meta.url).href,import.meta.url),{type:"module"});return n.onmessage=l=>{const{id:m,html:y,error:x}=l.data;if(m==="ready"){h(!0);return}r.current===m&&(x?a(x):(o(y),a(null)),r.current=null)},n.onerror=l=>{console.error("Markdown worker error:",l),a("Worker error occurred"),h(!1)},f.current=n,()=>{n.terminate()}},[]);const i=s.useCallback(n=>{if(!f.current||!d)return;const l=`request-${++v.current}`;r.current=l;const m={id:l,markdown:n};f.current.postMessage(m)},[d]);return{html:t,parse:i,isReady:d,error:c}}function O(t,o){const[d,h]=s.useState(t);return s.useEffect(()=>{const c=setTimeout(()=>{h(t)},o);return()=>{clearTimeout(c)}},[t,o]),d}function T({content:t,isMarkdown:o}){const{html:d,parse:h,isReady:c,error:a}=M(),f=O(t,300);return s.useEffect(()=>{o&&c&&f&&h(f)},[f,o,c,h]),o?a?e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",children:e.jsxs("div",{className:"empty-state",style:{color:"#ef4444"},children:["Error: ",a]})})]}):t?e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",dangerouslySetInnerHTML:{__html:d}})]}):e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",children:e.jsx("div",{className:"empty-state",children:"Preview will appear here for markdown files"})})]}):e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",children:e.jsx("div",{className:"empty-state",children:"Preview available for markdown files only"})})]})}function V(){const t=I(g.repository.owner,g.repository.name),{startTimer:o,endTimer:d}=P("cms"),[h,c]=s.useState([]),[a,f]=s.useState(null),[v,r]=s.useState(""),[i,n]=s.useState(!1),[l,m]=s.useState(!1),[y,x]=s.useState(!0);s.useEffect(()=>{w()},[]);const w=async()=>{try{x(!0);const p=(await t.listDirectory("")).filter(j=>!j.name.startsWith(".")&&j.name!=="node_modules");c(p)}catch(u){console.error("Error loading directory:",u),alert(`Error: ${u.message}`)}finally{x(!1)}},S=s.useCallback(async u=>{try{return(await t.listDirectory(u)).filter(j=>!j.name.startsWith(".")&&j.name!=="node_modules")}catch(p){return console.error("Error loading directory:",p),[]}},[t]),C=s.useCallback(async u=>{if(u.type!=="dir"&&!(i&&!confirm("You have unsaved changes. Discard them?")))try{const p=await t.getFile(u.path);f(p),r(p.content),n(!1)}catch(p){alert(`Error loading file: ${p.message}`)}},[t,i]),N=s.useCallback(u=>{r(u),n(!0)},[]),b=s.useCallback(async()=>{if(!(!a||!i)){m(!0);try{o("save_latency_ms");const u=`Update ${a.path.split("/").pop()}`;await t.updateFile(a.path,v,a.sha,u);const p=await t.getFile(a.path);d("save_latency_ms"),f(p),n(!1),alert("Saved successfully!")}catch(u){alert(`Error saving: ${u.message}`)}finally{m(!1)}}},[a,v,i,t,o,d]),k=()=>{i&&!confirm("You have unsaved changes. Close anyway?")||window.parent.postMessage("close-app","*")},R=a?.path.endsWith(".md")||!1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100vh"},children:[e.jsxs("div",{className:"header",children:[e.jsx("h2",{children:"Content Manager"}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsxs("button",{className:"btn btn-success",onClick:b,disabled:!i||l,children:[e.jsx(F,{size:16}),l?"Saving...":"Save"]}),e.jsxs("button",{className:"btn",onClick:k,children:[e.jsx(L,{size:16}),"Close"]})]})]}),e.jsxs("div",{className:"main",children:[e.jsxs("div",{className:"sidebar",children:[e.jsx("div",{className:"sidebar-header",children:"Repository Files"}),y?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#9ca3af"},children:"Loading..."}):e.jsx($,{files:h,onFileSelect:C,selectedFile:a?{...a,type:"file"}:null,onLoadDirectory:S})]}),e.jsxs("div",{className:"editor-area",children:[e.jsx(_,{content:v,onChange:N,disabled:!a}),e.jsx(T,{content:v,isMarkdown:R})]})]})]})}export{V as default};
